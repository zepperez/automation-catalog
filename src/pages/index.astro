---
import BaseLayout from '../layouts/BaseLayout.astro';
import StatsCard from '../components/StatsCard.astro';
import AutomationCard from '../components/AutomationCard.astro';
import TimeSeriesChart from '../components/TimeSeriesChart';
import { loadAutomations, getExpiringApiKeys, loadEngineers } from '../utils/data';

const automations = loadAutomations();
const engineers = loadEngineers();

// Calculate stats
const totalTimeSaved = automations.reduce((sum, a) => sum + a.time_saved_hours_per_month, 0);
const totalAnnualValue = automations.reduce((sum, a) => sum + a.annual_value_usd, 0);
const expiringKeys = getExpiringApiKeys(90);

// Calculate current month growth
const now = new Date();
const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
const currentMonthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);

const automationsThisMonth = automations.filter(a => {
  const createdDate = new Date(a.created);
  return createdDate >= currentMonthStart && createdDate <= currentMonthEnd;
});

const growthAutomations = automationsThisMonth.length;
const growthTimeSaved = automationsThisMonth.reduce((sum, a) => sum + a.time_saved_hours_per_month, 0);
const growthAnnualValue = automationsThisMonth.reduce((sum, a) => sum + a.annual_value_usd, 0);

// Calculate keys expiring this month (within 30 days)
const keysExpiringThisMonth = getExpiringApiKeys(30).length;
const previousKeysExpiring = getExpiringApiKeys(90).length - keysExpiringThisMonth;
const growthExpiringKeys = keysExpiringThisMonth;

// Generate time series data based on automation creation dates
// This shows cumulative time saved and value as automations were added
const generateTimeSeriesData = () => {
  // Get the last 12 months
  const months: { month: string; date: Date; hours: number; value: number }[] = [];
  const now = new Date();

  for (let i = 11; i >= 0; i--) {
    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
    // Use the last day of the month (or today if it's the current month)
    const endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    const compareDate = i === 0 ? now : endOfMonth;

    months.push({
      month: date.toLocaleDateString('en-US', { month: 'short' }),
      date: compareDate,
      hours: 0,
      value: 0
    });
  }

  // Calculate cumulative time saved and value for each month
  months.forEach((monthData) => {
    // Sum time saved and value from all automations created up to this month
    const automationsUpToThisMonth = automations.filter(a => {
      const createdDate = new Date(a.created);
      return createdDate <= monthData.date;
    });

    monthData.hours = automationsUpToThisMonth.reduce((sum, a) => sum + a.time_saved_hours_per_month, 0);
    // Convert annual value to monthly value by dividing by 12
    monthData.value = Math.round(automationsUpToThisMonth.reduce((sum, a) => sum + (a.annual_value_usd / 12), 0));
  });

  // Return in the format expected by the chart
  return months.map(m => ({ month: m.month, hours: m.hours, value: m.value }));
};

const timeSeriesData = generateTimeSeriesData();

// Get recent automations
const recentAutomations = [...automations]
  .sort((a, b) => new Date(b.last_updated).getTime() - new Date(a.last_updated).getTime())
  .slice(0, 3);

const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(amount);
};

// Pre-process expiring keys with their styles
const processedExpiringKeys = expiringKeys.slice(0, 5).map(key => {
  const daysUntilExpiration = Math.ceil(
    (new Date(key.expiration!).getTime() - Date.now()) / (1000 * 60 * 60 * 24)
  );
  const isUrgent = daysUntilExpiration <= 30;

  return {
    ...key,
    daysUntilExpiration,
    isUrgent,
    borderClass: isUrgent ? 'border-red-500' : 'border-yellow-500',
    badgeClass: isUrgent ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700',
  };
});
---

<BaseLayout title="Dashboard - Automation Catalog">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100">Dashboard</h1>
      <p class="mt-2 text-gray-600 dark:text-gray-400">
        Overview of all DevOps automations and their impact
      </p>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <StatsCard
        title="Total Automations"
        value={automations.length}
        icon="ðŸ¤–"
        subtitle={`Across ${new Set(automations.map(a => a.department)).size} departments`}
        growth={growthAutomations}
      />

      <StatsCard
        title="Monthly Time Saved"
        value={`${totalTimeSaved}h`}
        icon="â±ï¸"
        subtitle="Across all automations"
        growth={growthTimeSaved}
      />

      <StatsCard
        title="Annual Value"
        value={formatCurrency(totalAnnualValue)}
        icon="ðŸ’°"
        subtitle="Total business value"
        growth={growthAnnualValue}
      />

      <StatsCard
        title="Keys Expiring Soon"
        value={expiringKeys.length}
        icon="ðŸ”‘"
        subtitle="Within 90 days"
        growth={growthExpiringKeys}
      />
    </div>

    <!-- Time Series Chart -->
    <div class="mb-8">
      <TimeSeriesChart
        client:load
        data={timeSeriesData}
        title="Automation Impact Trend"
      />
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Recent Automations -->
      <div>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Recent Updates</h2>
          <a href="/automations" class="text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 font-medium">
            View All â†’
          </a>
        </div>
        <div class="space-y-4">
          {recentAutomations.map(automation => (
            <AutomationCard automation={automation} />
          ))}
        </div>
      </div>

      <!-- Upcoming Expirations -->
      <div>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-4">Upcoming Expirations</h2>
        <div class="card p-6">
          {expiringKeys.length === 0 ? (
            <p class="text-gray-500 dark:text-gray-400 text-center py-8">
              âœ… No API keys expiring in the next 90 days
            </p>
          ) : (
            <div class="space-y-4">
              {processedExpiringKeys.map(key => (
                <div class={`border-l-4 pl-4 py-2 ${key.borderClass}`}>
                  <div class="flex justify-between items-start">
                    <div>
                      <h3 class="font-semibold text-gray-900 dark:text-gray-100">{key.name}</h3>
                      <p class="text-sm text-gray-600 dark:text-gray-400">{key.system}</p>
                      <a
                        href={`/automations/${key.automationId}`}
                        class="text-xs text-primary-600 dark:text-primary-400 hover:underline"
                      >
                        {key.automationName}
                      </a>
                    </div>
                    <div class="text-right">
                      <span class={`badge ${key.badgeClass}`}>
                        {key.daysUntilExpiration}d
                      </span>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        {new Date(key.expiration!).toLocaleDateString()}
                      </p>
                    </div>
                  </div>
                </div>
              ))}
              {expiringKeys.length > 5 && (
                <a href="/calendar" class="block text-center text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 font-medium pt-4 border-t dark:border-gray-700">
                  View All on Calendar â†’
                </a>
              )}
            </div>
          )}
        </div>

        <!-- Department Breakdown -->
        <div class="mt-8">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-4">By Department</h2>
          <div class="card p-6">
            <div class="space-y-3">
              {Array.from(new Set(automations.map(a => a.department))).map(dept => {
                const deptAutomations = automations.filter(a => a.department === dept);
                const deptTimeSaved = deptAutomations.reduce((sum, a) => sum + a.time_saved_hours_per_month, 0);

                return (
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="font-medium text-gray-900 dark:text-gray-100 capitalize">{dept}</span>
                      <span class="text-sm text-gray-500 dark:text-gray-400 ml-2">
                        ({deptAutomations.length} automation{deptAutomations.length !== 1 ? 's' : ''})
                      </span>
                    </div>
                    <div class="text-right">
                      <span class="font-semibold text-gray-900 dark:text-gray-100">{deptTimeSaved}h/mo</span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        <!-- Automations per Engineer -->
        <div class="mt-8">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-4">Automations per Engineer</h2>
          <div class="card p-6">
            <div class="space-y-3">
              {engineers.map(engineer => {
                const engineerAutomations = automations.filter(a => a.author === engineer.id);

                if (engineerAutomations.length === 0) return null;

                const engineerTimeSaved = engineerAutomations.reduce((sum, a) => sum + a.time_saved_hours_per_month, 0);
                const liveCount = engineerAutomations.filter(a => a.status === 'live').length;
                const devCount = engineerAutomations.filter(a => a.status === 'development').length;
                const backlogCount = engineerAutomations.filter(a => a.status === 'backlog').length;

                return (
                  <div class="border-l-4 border-primary-500 pl-4 py-2">
                    <div class="flex justify-between items-start mb-2">
                      <div>
                        <div class="flex items-center gap-2">
                          <span class="font-semibold text-gray-900 dark:text-gray-100">{engineer.name}</span>
                          <span class="text-sm text-gray-500 dark:text-gray-400">
                            {engineer.role}
                          </span>
                        </div>
                        <div class="flex gap-2 mt-1">
                          {liveCount > 0 && (
                            <span class="badge bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 text-xs">
                              {liveCount} live
                            </span>
                          )}
                          {devCount > 0 && (
                            <span class="badge bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 text-xs">
                              {devCount} dev
                            </span>
                          )}
                          {backlogCount > 0 && (
                            <span class="badge bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs">
                              {backlogCount} backlog
                            </span>
                          )}
                        </div>
                      </div>
                      <div class="text-right">
                        <div class="font-bold text-gray-900 dark:text-gray-100">{engineerAutomations.length}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">automation{engineerAutomations.length !== 1 ? 's' : ''}</div>
                        <div class="text-sm font-semibold text-primary-600 dark:text-primary-400 mt-1">
                          {engineerTimeSaved}h/mo
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>
